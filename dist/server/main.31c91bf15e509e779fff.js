(()=>{"use strict";var e={479:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this.TIMERINTERVAL=200,this._maxTime=0,this._time=0}get time(){return this._time}get maxTime(){return this._maxTime}reset(){if(void 0===this.timer)throw Error("Can not reset the timer. Timer was not set!");clearInterval(this.timer),this.timer=void 0,this._time=0,this._maxTime=0}restart(){const e=this._maxTime;this.reset(),this.start(e,this.callback)}start(e,t){this._maxTime=e,this.callback=t,this.timer=setInterval((()=>{this._time>=this._maxTime&&(this.reset(),t()),this._time+=this.TIMERINTERVAL}),this.TIMERINTERVAL)}add(e){const t=this._maxTime-this._time;this.reset(),t+e>=0&&this.start(t+e,this.callback)}}},97:function(e,t,i){var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(r,n){function a(e){try{d(s.next(e))}catch(e){n(e)}}function o(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}d((s=s.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(952),a=r(i(292)),o=r(i(479)),d=r(i(685)).default.createServer();d.listen(Number(process.env.PORT)||3e3);const l=new n.Server(d,{cors:{origin:["https://zesty-gecko-26d2c4.netlify.app/","http://127.0.0.1:8080"],methods:["GET","POST"]}});function c(e){return a.default.writeFile("CurrentPlayers.json",JSON.stringify(e))}function u(){return s(this,void 0,void 0,(function*(){return JSON.parse((yield a.default.readFile("CurrentPlayers.json")).toString("utf-8"))}))}function m(e,t){if(void 0===e.players[t]){const i=`Can not delete the user ${t}.\nThere is no such user in\n${e.players}!`;throw Error(i)}for(let i of e.players[t].invited)void 0!==e.players[i]&&e.players[i].wasInvited.splice(e.players[i].wasInvited.indexOf(t),1);for(let i of e.players[t].invited)void 0!==e.players[i]&&e.players[i].invited.splice(e.players[i].invited.indexOf(t),1);delete e.players[t]}function f(e,t,i=""){return Object.keys(e.players).includes(t)&&(""===i||e.players[t].username===i)}function v(e,t){const i=Object.values(e.games);let s;for(let e of i)Object.keys(e.players).includes(t)&&(s=Object.keys(e.players)[1]);return s||!1}function h(e,t,i){let s,r,n;for(let i of Object.entries(e.games))Object.keys(i[1].players).includes(t)&&(s=i[0],r=Object.entries(i[1].players).filter((e=>e[0]!==t))[0],n=i[1].players[t]);if(void 0===r||void 0===s||void 0===n){const i=`Can not delete the user ${t}.\nThere is no such user in\n${JSON.stringify(e.games)}!`;throw Error(i)}i||(e.players[t]={username:n,invited:[],wasInvited:[]}),e.players[r[0]]={username:r[1],invited:[],wasInvited:[]},l.to(r[0]).emit("gameOver"),delete e.games[s]}l.on("connection",(function(e){e.on("enter",(t=>s(this,void 0,void 0,(function*(){const i=yield u();if(f(i,e.id,t))return;let r=!0,n="",a="";const d=new o.default,p=e=>s(this,void 0,void 0,(function*(){if(!r)return;const t=yield u();var i,s;e.emit("sessionsupdate",(i=t.players,s=e.id,Object.entries(i).filter((e=>e[0]!==s)).map((e=>({socketID:e[0],username:e[1].username,invited:e[1].invited.includes(s),wasInvited:e[1].wasInvited.includes(s)}))))),setTimeout((()=>{p(e)}),1e3)})),y=function(e,t,i){return!Object.values(e.players).map((e=>e.username)).includes(i)&&(e.players[t]={username:i,invited:[],wasInvited:[]},!0)}(i,e.id,t);if(!y)return void e.emit("enterFailure","username already exists");e.emit("enterSuccess"),yield c(i),p(e);const w=()=>s(this,void 0,void 0,(function*(){const t=yield u();if(!v(t,e.id))throw Error("Can't leave the game. Not in multiplayer currently!");h(t,e.id,!1),c(t),r=!0,n=a=""}));e.on("invite",(t=>s(this,void 0,void 0,(function*(){const i=yield u();f(i,t)&&(i.players[e.id].invited.push(t),i.players[t].wasInvited.push(e.id),c(i))})))),e.on("cancelInvite",((t,i)=>s(this,void 0,void 0,(function*(){const s=yield u();f(s,t)&&(i?(s.players[e.id].invited.splice(s.players[e.id].invited.indexOf(t),1),s.players[t].wasInvited.splice(s.players[t].wasInvited.indexOf(e.id),1)):(s.players[e.id].wasInvited.splice(s.players[e.id].wasInvited.indexOf(t),1),s.players[t].invited.splice(s.players[t].invited.indexOf(e.id),1)),c(s))})))),e.on("acceptInvite",(t=>s(this,void 0,void 0,(function*(){const i=yield u();if(!f(i,t))return;const s={players:{[e.id]:i.players[e.id].username,[t]:i.players[t].username},currentGame:Array(9).fill(null)};i.games[t]=s,l.to(e.id).emit("startGame",i.players[t].username,!0),l.to(t).emit("startGame",i.players[e.id].username,!1),m(i,t),m(i,e.id),yield c(i)})))),e.on("timeout",((t=1e3)=>s(this,void 0,void 0,(function*(){if(""===n||""===a){const t=yield u(),i=v(t,e.id);if("boolean"==typeof i)return;r=!1,a=i,n=Object.keys(t.games[a].players).filter((t=>t!==e.id))[0]}0!==d.maxTime&&d.reset(),d.start(1e3*t,w)})))),e.on("restartMatch",(function t(){return s(this,void 0,void 0,(function*(){l.to(n).emit("restartMatch"),e.on("restartMatch",(function i(){l.to(e.id).emit("restartMatch"),l.to(n).emit("restartMatch"),d.reset(),d.start(1e4,(()=>{e.emit("timeIsUp",!0)})),e.on("restartMatch",t),e.off("restartMatch",i)})),e.off("restartMatch",t)}))})),e.on("move",(e=>s(this,void 0,void 0,(function*(){const t=yield u();t.games[a].currentGame[e]&&(function(e,t){e.games[t].currentGame=Array(9).fill(null)}(t,a),l.to(a).emit("restartMatch")),t.games[a].currentGame[e]=1,l.to(n).emit("move",e)})))),e.on("leaveGame",w),e.on("disconnect",(()=>s(this,void 0,void 0,(function*(){console.log("disconnect");const t=yield u();if(f(t,e.id))m(t,e.id);else{if(!v(t,e.id))throw Error(`Something went wrong. Here is dbData:\n${t}`);h(t,e.id,!0)}c(t)}))))}))))}))},952:e=>{e.exports=require("socket.io")},292:e=>{e.exports=require("fs/promises")},685:e=>{e.exports=require("http")}},t={};!function i(s){var r=t[s];if(void 0!==r)return r.exports;var n=t[s]={exports:{}};return e[s].call(n.exports,n,n.exports,i),n.exports}(97)})();